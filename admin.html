<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin - Pratik</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen">

    <div id="login-screen" class="container mx-auto p-6 max-w-md mt-20">
        <h1 class="text-3xl font-bold text-center text-white mb-6">Admin Login</h1>
        <form id="login-form" class="bg-slate-800 p-8 rounded-lg shadow-xl space-y-6">
            <div>
                <label for="email" class="block text-sm font-medium text-slate-300">Email</label>
                <input type="email" id="email" required class="mt-1 block w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white focus:ring-sky-500 focus:border-sky-500">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-slate-300">Password</label>
                <input type="password" id="password" required class="mt-1 block w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white focus:ring-sky-500 focus:border-sky-500">
            </div>
            <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition duration-300">Login</button>
            <p id="login-error" class="text-red-400 text-sm text-center"></p>
        </form>
    </div>

    <div id="admin-panel" class="hidden container mx-auto p-6">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">Admin Panel</h1>
            <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-5 rounded-lg transition duration-300">Logout</button>
        </header>

        <div class="mb-6 border-b border-slate-700">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-projects" class="tab-button text-sky-400 border-sky-400 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                    Projects
                </button>
                <button id="tab-messages" class="tab-button text-slate-400 hover:text-slate-200 border-transparent whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                    Messages
                </button>
            </nav>
        </div>

        <div id="content-projects" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <form id="project-form" class="bg-slate-800 p-6 rounded-lg shadow-xl space-y-4">
                    <h2 id="form-title" class="text-2xl font-semibold text-white mb-4">Add New Project</h2>
                    <input type="hidden" id="project-id">
                    <div>
                        <label for="project-title" class="block text-sm font-medium text-slate-300">Title</label>
                        <input type="text" id="project-title" required class="mt-1 block w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label for="project-desc" class="block text-sm font-medium text-slate-300">Description</label>
                        <textarea id="project-desc" rows="4" required class="mt-1 block w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:ring-sky-500 focus:border-sky-500"></textarea>
                    </div>
                    <div>
                        <label for="project-image" class="block text-sm font-medium text-slate-300">Image URL</label>
                        <input type="text" id="project-image" placeholder="https://example.com/image.png" class="mt-1 block w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label for="project-tags" class="block text-sm font-medium text-slate-300">Tags (comma-separated)</label>
                        <input type="text" id="project-tags" placeholder="React, Node.js, ..." class="mt-1 block w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div class="flex space-x-2 pt-2">
                        <button type="submit" id="project-submit-btn" class="flex-1 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Save Project</button>
                        <button type="button" id="project-cancel-btn" class="hidden flex-1 bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Cancel</button>
                    </div>
                </form>
            </div>
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-semibold text-white mb-4">Existing Projects</h2>
                <div id="projects-list" class="space-y-4">
                    </div>
            </div>
        </div>

        <div id="content-messages" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-white mb-4">Contact Messages</h2>
            <div id="messages-list" class="space-y-4">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginScreen = document.getElementById('login-screen');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutButton = document.getElementById('logout-button');

            const projectForm = document.getElementById('project-form');
            const projectsList = document.getElementById('projects-list');
            const messagesList = document.getElementById('messages-list');
            
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            const formTitle = document.getElementById('form-title');
            const projectId = document.getElementById('project-id');
            const projectTitle = document.getElementById('project-title');
            const projectDesc = document.getElementById('project-desc');
            const projectImage = document.getElementById('project-image');
            const projectTags = document.getElementById('project-tags');
            const projectSubmitBtn = document.getElementById('project-submit-btn');
            const projectCancelBtn = document.getElementById('project-cancel-btn');

            let token = localStorage.getItem('token');

            const api = {
                headers: () => ({
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }),
                login: async (email, password) => {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    return { ok: res.ok, data: await res.json() };
                },
                getProjects: () => fetch('/api/admin/projects', { headers: api.headers() }).then(res => res.json()),
                getMessages: () => fetch('/api/admin/messages', { headers: api.headers() }).then(res => res.json()),
                deleteProject: (id) => fetch(`/api/admin/projects/${id}`, { method: 'DELETE', headers: api.headers() }),
                deleteMessage: (id) => fetch(`/api/admin/messages/${id}`, { method: 'DELETE', headers: api.headers() }),
                createProject: (data) => fetch('/api/admin/projects', {
                    method: 'POST',
                    headers: api.headers(),
                    body: JSON.stringify(data)
                }),
                updateProject: (id, data) => fetch(`/api/admin/projects/${id}`, {
                    method: 'PUT',
                    headers: api.headers(),
                    body: JSON.stringify(data)
                })
            };

            function showAdminPanel() {
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadProjects();
                loadMessages();
            }

            function showLoginScreen() {
                localStorage.removeItem('token');
                token = null;
                loginScreen.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }

            async function handleLogin(e) {
                e.preventDefault();
                loginError.textContent = '';
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                try {
                    const res = await api.login(email, password);
                    if (res.ok) {
                        token = res.data.token;
                        localStorage.setItem('token', token);
                        showAdminPanel();
                    } else {
                        loginError.textContent = res.data.error || 'Login failed';
                    }
                } catch (err) {
                    loginError.textContent = 'Network error';
                }
            }

            async function loadProjects() {
                try {
                    const projects = await api.getProjects();
                    if(projects.error) return showLoginScreen();
                    
                    projectsList.innerHTML = projects.map(p => `
                        <div class="bg-slate-800 p-4 rounded-lg flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-semibold text-white">${p.title}</h3>
                                <p class="text-sm text-slate-400">${p.description.substring(0, 100)}...</p>
                                <div class="mt-2 flex flex-wrap gap-1">
                                    ${(p.tags || []).map(t => `<span class="bg-slate-700 text-sky-300 text-xs font-semibold px-2 py-0.5 rounded-full">${t}</span>`).join('')}
                                </div>
                            </div>
                            <div class="flex-shrink-0 flex space-x-2 ml-4">
                                <button data-id="${p._id}" class="edit-project-btn bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium py-1 px-3 rounded-md">Edit</button>
                                <button data-id="${p._id}" class="delete-project-btn bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-1 px-3 rounded-md">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } catch (err) { console.error('Failed to load projects'); }
            }

            async function loadMessages() {
                try {
                    const messages = await api.getMessages();
                    if(messages.error) return; // Handled by project load
                    
                    messagesList.innerHTML = messages.map(m => `
                        <div class="bg-slate-800 p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-semibold text-white">${m.name} <span class="text-sm text-slate-400 font-normal">&lt;${m.email}&gt;</span></h3>
                                    <p class="text-sm text-slate-500">${new Date(m.createdAt).toLocaleString()}</p>
                                </div>
                                <button data-id="${m._id}" class="delete-message-btn flex-shrink-0 bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-1 px-3 rounded-md ml-4">Delete</button>
                            </div>
                            <p class="mt-3 text-slate-300 whitespace-pre-wrap">${m.message}</p>
                        </div>
                    `).join('');
                } catch (err) { console.error('Failed to load messages'); }
            }

            function resetProjectForm() {
                formTitle.textContent = 'Add New Project';
                projectSubmitBtn.textContent = 'Save Project';
                projectCancelBtn.classList.add('hidden');
                projectForm.reset();
                projectId.value = '';
            }

            async function handleProjectSubmit(e) {
                e.preventDefault();
                const data = {
                    title: projectTitle.value,
                    description: projectDesc.value,
                    image: projectImage.value,
                    tags: projectTags.value
                };
                
                const id = projectId.value;
                try {
                    if (id) {
                        await api.updateProject(id, data);
                    } else {
                        await api.createProject(data);
                    }
                    resetProjectForm();
                    loadProjects();
                } catch (err) {
                    console.error('Failed to save project');
                }
            }

            projectsList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-project-btn')) {
                    if (!confirm('Are you sure you want to delete this project?')) return;
                    const id = e.target.dataset.id;
                    await api.deleteProject(id);
                    loadProjects();
                }
                
                if (e.target.classList.contains('edit-project-btn')) {
                    const id = e.target.dataset.id;
                    const projects = await api.getProjects();
                    const project = projects.find(p => p._id === id);
                    if (project) {
                        formTitle.textContent = 'Edit Project';
                        projectSubmitBtn.textContent = 'Update Project';
                        projectCancelBtn.classList.remove('hidden');
                        projectId.value = project._id;
                        projectTitle.value = project.title;
                        projectDesc.value = project.description;
                        projectImage.value = project.image || '';
                        projectTags.value = (project.tags || []).join(', ');
                        window.scrollTo(0, 0);
                    }
                }
            });

            messagesList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-message-btn')) {
                    if (!confirm('Are you sure you want to delete this message?')) return;
                    const id = e.target.dataset.id;
                    await api.deleteMessage(id);
                    loadMessages();
                }
            });

            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.classList.remove('text-sky-400', 'border-sky-400');
                        t.classList.add('text-slate-400', 'hover:text-slate-200', 'border-transparent');
                    });
                    tab.classList.add('text-sky-400', 'border-sky-400');
                    tab.classList.remove('text-slate-400', 'hover:text-slate-200', 'border-transparent');
                    
                    tabContents.forEach(content => content.classList.add('hidden'));
                    const contentId = tab.id.replace('tab-', 'content-');
                    document.getElementById(contentId).classList.remove('hidden');
                });
            });

            // Init
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', showLoginScreen);
            projectForm.addEventListener('submit', handleProjectSubmit);
            projectCancelBtn.addEventListener('click', resetProjectForm);

            if (token) {
                showAdminPanel();
            } else {
                showLoginScreen();
            }
        });
    </script>
</body>
</html>